<script language="JavaScript">var PUpage="76001067"; var PUprop="geocities"; </script><script language="JavaScript" src="http://www.geocities.com/js_source/pu5geo.js"></script><script language="JavaScript"> var thGetOv="http://themis.geocities.yahoo.com/themis/h.php"; var thCanURL="http://us.geocities.com/v_d_d/Alternative_OPT_File_Reading.html"; var thSpaceId="76001067"; var thIP="72.226.234.208"; var thTs="1182016287"; var thCs="9d0f0288538ae2873a99e95a917c6596";</script><noscript><link rel="stylesheet" href="http://themis.geocities.yahoo.com/jsoff.css?thIP=72.226.234.208&thTs=1182016287"></noscript><script language="JavaScript" src="http://us.geocities.com/js_source/geovck08.js"></script>
<!-- text above generated by server. PLEASE REMOVE -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>Alternative OPT File Reading</TITLE>
<META http-equiv=Content-Type content="text/html; charset=ISO-8859-1">
<BODY text=#000000 bgColor=#ffffff>
<!-- following code added by server. PLEASE REMOVE -->
<link href="http://us.geocities.com/js_source/div.css" rel="stylesheet" type="text/css"><script language="JavaScript" src="http://us.geocities.com/js_source/div03.js"></script>
<!-- preceding code added by server. PLEASE REMOVE -->

<P align=center><FONT face=Arial color=#0000ff size=5><STRONG>Alternative OPT File 
Reading<BR></STRONG></FONT><FONT face=Arial color=#0000ff size=3>Last Updated 
July 18, 1998<BR>By </FONT><FONT face=Arial color=#0000ff 
size=3>3DOXprt</FONT></A></P>
<P>&nbsp;</P>
<P><FONT face=Arial><STRONG>Introduction</STRONG></FONT></P>
<P>This document wouldn't exist if it weren't for the hard work of my buds, Stealthjedi and Lt. Hag. 
Also, I would like to thank all others who have contributed to the OPT Project since its 
birth.</P>
<P>This document is to serve as a guide to creating a robust X-Wing vs. Tie 
Fighter OPT File reader 
using a method that we will call Jump Blocking. I have a tendency for dramatics, 
so you will have to forgive the storybook style in which I present this article. 
I would like to make one thing clear, and that is that this is an exercise not a 
solution. Our understanding of OPT Files is literally 
changing every hour, as such it would be wrong if I said this is <EM>how</EM> to 
read OPT files, this is 
simply my preferred method. Visit <A 
href="http://code-alliance.com/">code-alliance.com</A> to get all the latest 
news on this file format.</P>
<P>&nbsp;</P>
<P><FONT face=Arial><STRONG>A Description</STRONG></FONT></P>
<P>OPT Files can easily 
be seen as horrendously complex and convoluted. In fact they are, if you try to 
read them at face value. We will try to read them as I believe they were meant 
to be.</P>
<P>As stated in the Unofficial OPT Specs, an OPT is a complex collection 
of jumps (offsets to different parts of the file) and Headers. A Header could be 
anything from a mesh declaration, to a grouping of faces. We have found, and 
declared, many such headers. But it has gotten to the point where some groups of 
data are so nested away within the file that our naming conventions are tiring 
and failing.</P>
<P>I describe the OPT 
file as having three distinct parts: a Header, Jump Blocks, and Data Blocks. 
There is only one header in the file, but there can be any number of Jump Blocks 
and Data Blocks. I have written a paradigm that I use to use to explain the 
format: <EM>Jump Blocks are simply 'way stations' creating a hierarchy that is 
beneficial to an animation engine but serve no other purpose. Each Jump Block 
should be followed through for the sole purpose of searching for Data Blocks. 
Data Blocks contain specific information about the object and are terminators of 
the Block Hierarchy</EM>.</P>
<P>I will use a 32-bit C++ naming convention through the file. Types used 
include:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD>int</TD>
    <TD>32-bit Signed Integer</TD></TR>
  <TR>
    <TD>float</TD>
    <TD>32-bit Floating-point value</TD></TR>
  <TR>
    <TD>char</TD>
    <TD>8-bit Signed Integer</TD></TR>
  <TR>
    <TD>a[x]</TD>
    <TD>An array of <EM>x</EM> items of type <EM>a</EM> from 0 to 
  x-1</TD></TR></TBODY></TABLE></DIV>
<P>&nbsp;</P>
<P><FONT face=Arial><STRONG>The OPT 
Format</STRONG></FONT></P>
<P>Like all other files, we begin with the header. The OPT File Header takes this 
form:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD>int</TD>
    <TD>FileStart</TD>
    <TD>Always 0xFFFFFFFF</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>FileSize</TD>
    <TD>Excluding FileSize and FileStart (-8)</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>GlobalOffset</TD>
    <TD>Very important value used to locate Jump offsets</TD></TR>
  <TR>
    <TD>char[2]</TD>
    <TD>&lt;noname&gt;</TD>
    <TD>Always {2, 0}</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>NumJumps</TD>
    <TD>&nbsp;</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>JumpToJumps</TD>
    <TD>A Jump to the first Jump in the list of Jumps</TD></TR>
  <TR>
    <TD>int[NumJumps]</TD>
    <TD>Jumps</TD>
    <TD>The List of Jumps</TD></TR></TBODY></TABLE></DIV>
<P>I need to take a minute discuss Jumping and the role of the GlobalOffset. A 
Jump is simply an address to another part of the file. The catch is, they are 
inflated by GlobalOffset. In order to see where in the file a jump points to, 
you must first subtract the GlobalOffset. It is also very important that you 
<FONT color=#ff2222>subtract 8 from the read GlobalValue to find the one that we 
will use</FONT>.</P>
<P>Furthermore, whenever you see a "JumpToJumps", "JumpToFloats" or likewise, 
use that value. Do not simply assume that the Jumps will immediately follow the 
JumpToJumps.</P>
<P>A detail: In our desire to organize OPT files, we have taken the 
stand that the Jumps declared in the header of the file represent individual 
meshes (collections of vertices, and faces). This is a good way to organize your 
own reader.</P>
<P>It's time now to declare the Jump Block structure. This is a key element to 
reading OPTs. As stated, A Jump Block is simply a collection of Jumps. These 
Jumps could point to Data Blocks or to yet another Jump Block. You should assume 
no patterns exist in the files.</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD>int</TD>
    <TD>&lt;no name&gt;</TD>
    <TD>Always (usually) 0</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>&lt;no name&gt;</TD>
    <TD>Always (usually) 0</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>NumJumps</TD>
    <TD>&nbsp;</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>JumpToJumps</TD>
    <TD>A Jump to the first Jump in the list of Jumps</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>&lt;no name&gt;</TD>
    <TD>Always (usually) 1</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>ReverseJump</TD>
    <TD>&nbsp;</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>&lt;no name&gt;</TD>
    <TD>Always (usually) 1 -- Does not always Exist!</TD></TR>
  <TR>
    <TD>int[NumJumps]</TD>
    <TD>Jumps</TD>
    <TD>List of Jumps</TD></TR></TBODY></TABLE></DIV>
<P>This is not the most complex structure. In fact, the ReverseJump is our only 
new piece of data. The ReverseJump acts a bit like the GlobalOffset. It exists 
to maintain the hierarchy. A child JumpBlock (that is, it is pointed to by this 
Block), can subtract its ReverseJump to get back to this Block (its parent). As 
of now, we have found no real use for these numbers, but who knows what the 
future will hold.</P>
<P>The last part of the file are Data Blocks. Although all Data Blocks have a 
different structure (because they hold different types of data), they each have 
a similar header. Their header is only two longs:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD>int</TD>
    <TD>BlockBegin</TD>
    <TD>Usually 0 (Exception is TextA Blocks)</TD></TR>
  <TR>
    <TD>int</TD>
    <TD>Identifier</TD>
    <TD>Tells what kind of Data Block this is</TD></TR></TBODY></TABLE></DIV>
<P>Not so bad eh? The Identifier is the most important part. It tells us what 
kind of Data Block this is (vertex, face, texture, hardpoint, etc) and from this 
we can dispatch the data to different functions. We would have a function 
ReadVertexBlock(), ReadFaceBlock(), and so on.</P>
<P>We currently know of these types of Data Blocks:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD>1</TD>
    <TD>0x01</TD>
    <TD>Face Data</TD></TR>
  <TR>
    <TD>3</TD>
    <TD>0x03</TD>
    <TD>Vertex Data</TD></TR>
  <TR>
    <TD>7</TD>
    <TD>0x07</TD>
    <TD>Texture "B" Blocks</TD></TR>
  <TR>
    <TD>11</TD>
    <TD>0x0B</TD>
    <TD>Vertex Normals</TD></TR>
  <TR>
    <TD>13</TD>
    <TD>0x0D</TD>
    <TD>Texture Vertices</TD></TR>
  <TR>
    <TD>20</TD>
    <TD>0x14</TD>
    <TD>Texture "A" Blocks</TD></TR>
  <TR>
    <TD>21</TD>
    <TD>0x15</TD>
    <TD>Face Grouping Block</TD></TR>
  <TR>
    <TD>22</TD>
    <TD>0x16</TD>
    <TD>Hardpoints Block (Turrents, Blasters)</TD></TR>
  <TR>
    <TD>23</TD>
    <TD>0x17</TD>
    <TD>Insertion Offset ?</TD></TR>
  <TR>
    <TD>25</TD>
    <TD>0x19</TD>
    <TD>Minimum/Maximum Mesh Information</TD></TR></TBODY></TABLE></DIV>
<P>Please consult the OPT 
Unofficial Specs for specific information on these Blocks.</P>
<P>&nbsp;</P>
<P><FONT face=Arial><STRONG>How to Load an OPT File</STRONG></FONT></P>
<P>OK, so now we know all about how an OPT File is structured. It's 
time that we begin reading them. This section is short because the read process 
using Jump Blocking is a relatively easy and straightfoward process.</P>
<P>The process can be summed into the following process:</P>
<OL>
  <LI>Read the Header 
  <LI>For Each Jump 
  <LI>Read the 2nd int 
  <LI>if it is &gt; 0 then call the appropriate data loader 
  <LI>else Read the Jumps and loop back to #2 </LI></OL>
<P>So basically, we just process jumps until we have found a Data Block. If we 
find that this Jump Block is really a data Block, then we call the appropriate 
data loader function (ReadVertexBlock(), etc.). This continues until all jumps 
have been read, and the hierarchy has expired.</P>
<P>&nbsp;</P>
<P><FONT face=Arial><STRONG>A C++ Class to Load OPT 
Files</STRONG></FONT></P>
<P>Enough theory, let's create a class to do the loading. For simplification, 
the class will only support reading vertices, but don't fret, adding other data 
readers will be a snap.</P>
<P>The first class I wrote I named COptBlock. That is, because it can act either 
as a Jump Block or a Data Block. It is programmed to check which one it is and 
take the appropriate action. If it is a Data Block, it simply determines which 
data loader function to call, and that function is responsible for loading its 
data into the mesh pointed to by the COptBlock. If it is a Jump Block (second 
int == 0), then it creates the appropriate number of COptBlocks and calls the 
Read() and Process() functions of each. This creates and maintains a file 
hierarchy of classes while still completely independent of the order of things 
within the file. Here is the declaration of the COptBlock:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>class</FONT> COptBlock
{
<FONT color=#0000ff>public</FONT>:
    <FONT color=#0000ff>int</FONT> goff;
    FILE *pfile;
    <FONT color=#0000ff>int</FONT> filepos;
    COptBlock *jumps;
    <FONT color=#0000ff>int</FONT> njumps;
    <FONT color=#0000ff>int</FONT> jumpsoff;
    <FONT color=#0000ff>int</FONT> reverse;
    COptMesh *mesh;

    <FONT color=#0000ff>int</FONT> Read();
    <FONT color=#0000ff>int</FONT> Process();
    <FONT color=#0000ff>void</FONT> CallDataBlockReader(int ind);
    <FONT color=#0000ff>void</FONT> ReadVertexBlock();

    COptBlock();
    ~COptBlock();
};</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Everything should look familiar. goff is the GlobalOffset that has to be 
passed down to the Block, pfile is a pointer to the open OPT File, filepos is the 
file offset to this Block, jumps is a pointer that may or maynot be used to hold 
other COptBlocks, njumps is the number of jumps to be read/processed, jumpsoff 
is the offset to the list of jumps, reverse is the ReverseJump used to go back 
to the parent (though not supported in this class). Read() determines what type 
of Block this is (Data or Jump), calls CallDataBlockReader() if it is a Data 
Block, otherwise, it loads the various jumps. Process() will call the Read() and 
Process() functions for each Jump in this Block.</P>
<P>Included are the memory managing constructors and destructors:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE>COptBlock::COptBlock()
{
    jumps=<FONT color=#0000ff>0</FONT>;
    njumps=<FONT color=#0000ff>0</FONT>;
}</PRE><PRE>COptBlock::~COptBlock()
{
    <FONT color=#0000ff>if</FONT> (jumps)
        <FONT color=#0000ff>delete</FONT>[] jumps;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Nothing really complex there. Only one note: After constructing a COptBlock, 
it is imparative that you set the goff, pfile, filepos, and mesh members to 
their proper values. As you can see, there is no initialization for their 
values.</P>
<P>The Read() function is the brains of the COptBlock object:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>int</FONT> COptBlock::Read()
{
    <FONT color=#22aa22><EM>// Seek to the beginning of this Block</EM></FONT>
    fseek(pfile, filepos, SEEK_SET);
    <FONT color=#22aa22><EM>// Check if this is a Jump Block or Data Block</EM></FONT>
    <FONT color=#0000ff>int</FONT> ind;
    fseek(pfile, <FONT color=#0000ff>4L</FONT>, SEEK_CUR);
    fread(&amp;ind,<FONT color=#0000ff>sizeof</FONT>(ind),<FONT color=#0000ff>1</FONT>,pfile);
    <FONT color=#0000ff>if</FONT> (ind &gt; <FONT color=#0000ff>0</FONT>)
    {
        CallDataBlockReader(ind);
        <FONT color=#0000ff>return</FONT> <FONT color=#0000ff>0</FONT>;
    }
    <FONT color=#22aa22><EM>// Read the number of jumps</EM></FONT>
    fread(&amp;njumps,<FONT color=#0000ff>sizeof</FONT>(njumps),<FONT color=#0000ff>1</FONT>,pfile);
    fread(&amp;jumpsoff,<FONT color=#0000ff>sizeof</FONT>(jumpsoff),<FONT color=#0000ff>1</FONT>,pfile);
    jumpsoff -= goff;
    <FONT color=#22aa22><EM>// Read the reverse</EM></FONT>
    fseek(pfile, <FONT color=#0000ff>4L</FONT>, SEEK_CUR);
    fread(&amp;reverse,<FONT color=#0000ff>sizeof</FONT>(reverse),<FONT color=#0000ff>1</FONT>,pfile);
    <FONT color=#22aa22><EM>// Read the jumps</EM></FONT>
    jumps = <FONT color=#0000ff>new</FONT> COptBlock[njumps];
    fseek(pfile, jumpsoff, SEEK_SET);
    <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i=<FONT color=#0000ff>0</FONT>;i&lt;njumps;++i)
    {
        fread(&amp;jumps[i].filepos,<FONT color=#0000ff>sizeof</FONT>(<FONT color=#0000ff>int</FONT>),<FONT color=#0000ff>1</FONT>,pfile);
        jumps[i].filepos -= goff;
        jumps[i].goff = goff;
        jumps[i].pfile = pfile;
        jumps[i].mesh = mesh;
    }

    <FONT color=#0000ff>return</FONT> njumps;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>This code, too, is pretty straight-forward. Read the second int, call the 
DatBlock dispatch function if necessary, or simply read the jumps.</P>
<P>Next in line is the CallDataBlockReader() which simply decides which function 
to call:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>void</FONT> COptBlock::CallDataBlockReader(<FONT color=#0000ff>int</FONT> ind)
{
    <FONT color=#0000ff>switch</FONT> (ind)
    {
    <FONT color=#0000ff>case</FONT> <FONT color=#0000ff>3</FONT>:
        ReadVertexBlock();
        <FONT color=#0000ff>break</FONT>;
    }
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Of course, this function would be much longer if we were loading more Data 
Blocks. But, this is adequate for our purposes.</P>
<P>And now we have the Process() function. This will simply call the COptBlocks 
that we created in the Read() function.</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>int</FONT> COptBlock::Process()
{
    <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i=<FONT color=#0000ff>0</FONT>;i&lt;njumps;++i)
    {
        jumps[i].Read();
        jumps[i].Process();
    }

    <FONT color=#0000ff>return</FONT> njumps;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Finally, we have our Vertex Data Block Reader. This function simply appends 
the vertices declared in it to the vertex list already contained in the COptMesh 
(which I will declare later). The appending process is quite ugly, but I truly 
do not believe it will ever be called. Though, you will have to use a similar 
method when dealing with faces, for there are usually multiple face groups.</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>void</FONT> COptBlock::ReadVertexBlock()
{
    fseek(pfile,filepos,SEEK_SET);
    <FONT color=#22aa22><EM>// Get the number of vertices</EM></FONT>
    <FONT color=#0000ff>int</FONT> nv;
    fseek(pfile,<FONT color=#0000ff>16L</FONT>,SEEK_CUR);
    fread(&amp;nv,sizeof(nv),<FONT color=#0000ff>1</FONT>,pfile);
    <FONT color=#22aa22>// Grow our vertex list for this mesh</FONT>
    <FONT color=#0000ff>int</FONT> i;
    <FONT color=#0000ff>if</FONT> (mesh-&gt;verts)
    {
        <FONT color=#22aa22><EM>// create the new list to a temp pointer</EM></FONT>
        COptVertex *tp = <FONT color=#0000ff>new</FONT> COptVertex[mesh-&gt;nverts+nv];
        <FONT color=#22aa22><EM>// copy the old list to the new list</EM></FONT>
        <FONT color=#0000ff>for</FONT> (i=<FONT color=#0000ff>0</FONT>;i&lt;mesh-&gt;nverts;++i)
            tp[i] = mesh-&gt;verts[i];
        <FONT color=#22aa22>// kill the old list</FONT>
        <FONT color=#0000ff>delete</FONT>[] mesh-&gt;verts;
        <FONT color=#22aa22>// point it to the new list</FONT>
        mesh-&gt;verts = tp;
    }
    <FONT color=#0000ff>else</FONT>
    {
        mesh-&gt;verts = <FONT color=#0000ff>new</FONT> COptVertex[nv];
    }
    <FONT color=#22aa22><EM>// Get the position of the floats</EM></FONT>
    <FONT color=#0000ff>int</FONT> flts;
    fread(&amp;flts,sizeof(flts),<FONT color=#0000ff>1</FONT>,pfile);
    flts -= moff;
    <FONT color=#22aa22><EM>// Read all of the floats</EM></FONT>
    fseek(pfile,flts,SEEK_SET);
    <FONT color=#0000ff>for</FONT> (i=<FONT color=#0000ff>0</FONT>;i&lt;nv;++i)
    {
        fread(&amp;(mesh-&gt;verts[mesh-&gt;nverts+i].x),<FONT color=#0000ff>4</FONT>,<FONT color=#0000ff>1</FONT>,pfile);
        fread(&amp;(mesh-&gt;verts[mesh-&gt;nverts+i].y),<FONT color=#0000ff>4</FONT>,<FONT color=#0000ff>1</FONT>,pfile);
        fread(&amp;(mesh-&gt;verts[mesh-&gt;nverts+i].z),<FONT color=#0000ff>4</FONT>,<FONT color=#0000ff>1</FONT>,pfile);
    }
    <FONT color=#22aa22><EM>// Update the list count</EM></FONT>
    mesh-&gt;nverts += nv;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Like I said, the vertex "appending" process is pretty crude, if you know of a 
better technique, please post on the message board at <A 
href="http://www.code-alliance.com/">code-alliance</A>.</P>
<P>So that's all there is to reading an OPT! The rest of the code I 
post is just the details :-) First, I need to declare COptMesh and COptVertex 
and their constructors:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>class</FONT> COptVertex
{
<FONT color=#0000ff>public</FONT>:
    <FONT color=#0000ff>float</FONT> x,y,z;

    COptVertex();
};</PRE><PRE><FONT color=#0000ff>class</FONT> COptMesh
{
<FONT color=#0000ff>public</FONT>:
    COptVertex *verts;
    <FONT color=#0000ff>int</FONT> nverts;
	
    COptMesh();
    ~COptMesh();
};</PRE><PRE>COptVertex::COptVertex()
{
    x=y=z=<FONT color=#0000ff>0.0f</FONT>;
}</PRE><PRE>COptMesh::COptMesh()
{
    verts = <FONT color=#0000ff>0</FONT>;
    nverts = <FONT color=#0000ff>0</FONT>;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>No Mysteries there either. It's basically just a container for our datd to 
keep it all nice and tidy. If you had further developed these classes, you would 
add pointers to face data, texture data, and whatever else. Now, we have only 
one class left to define, and that is the main class. This is the one you would 
be dealing with if you wrote a OPT File reader. COptFile is 
simply a container for the meshes, and has a function (Load()) that reads the OPT Header and gets the 
reading process going. The constructor for this class automatically loads the 
file, and the destructor takes care of all our memory issues.</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>class</FONT> COptFile
{
<FONT color=#0000ff>public</FONT>:
    <FONT color=#0000ff>char</FONT> filename[<FONT color=#0000ff>128</FONT>];
    FILE *pfile;
    COptBlock *jumps;
    COptMesh *meshes;
    <FONT color=#0000ff>int</FONT> njumps;
    <FONT color=#0000ff>int</FONT> nmeshes;
    <FONT color=#0000ff>int</FONT> goff;
    <FONT color=#0000ff>int</FONT> jumpoff;

    COptFile(<FONT color=#0000ff>char</FONT> *fn);
    ~COptFile();
    <FONT color=#0000ff>void</FONT> Load();
};</PRE><PRE>COptFile::COptFile(<FONT color=#0000ff>char</FONT> *fn)
{
    <FONT color=#22aa22><EM>// Initialize</EM></FONT>
    jumps = <FONT color=#0000ff>0</FONT>;
    meshes = <FONT color=#0000ff>0</FONT>;
    njumps=nmeshes=<FONT color=#0000ff>0</FONT>;
    <FONT color=#22aa22><EM>// Load the file</EM></FONT>
    strcpy(filename,fn);
    Load();
}</PRE><PRE>COptFile::~COptFile()
{
    if (jumps)
        <FONT color=#0000ff>delete</FONT>[] jumps;
    if (meshes)
        <FONT color=#0000ff>delete</FONT>[] meshes;
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>The Load() function is very similar to the COptBlock::Read() function, but 
also handles the opening and closing of the file:</P>
<DIV align=left>
<TABLE cellSpacing=0 borderColorDark=#0000ff cellPadding=0 width=500 
borderColorLight=#ffffff border=1>
  <TBODY>
  <TR>
    <TD><PRE><FONT color=#0000ff>void</FONT> COptFile::Load()
{
    <FONT color=#22aa22><EM>// safeguard types used</EM></FONT>
    if (<FONT color=#0000ff>sizeof</FONT>(int) != 4)
    {
        <FONT color=#0000ff>return</FONT>;
    }
    <FONT color=#22aa22><EM>// Open the file</EM></FONT>
    pfile = fopen(filename,<FONT color=#0000ff>"r"</FONT>);
    if (pfile == <FONT color=#0000ff>0</FONT>)
    {
        <FONT color=#0000ff>return</FONT>;
    }
	
    <FONT color=#22aa22><EM>// Read the Master Offset (moff)</EM></FONT>
    fseek(pfile,<FONT color=#0000ff>8L</FONT>,SEEK_SET);
    fread(&amp;goff,<FONT color=#0000ff>sizeof</FONT>(goff),<FONT color=#0000ff>1</FONT>,pfile);
    goff -= <FONT color=#0000ff>8</FONT>;
    <FONT color=#22aa22><EM>// Read the number of master jumps/meshes</EM></FONT>
    fseek(pfile,<FONT color=#0000ff>2L</FONT>,SEEK_CUR);
    fread(&amp;njumps,<FONT color=#0000ff>sizeof</FONT>(njumps),<FONT color=#0000ff>1</FONT>,pfile);
    nmeshes=njumps;
    meshes = <FONT color=#0000ff>new</FONT> COptMesh[njumps];
    jumps = <FONT color=#0000ff>new</FONT> COptBlock[njumps];
    <FONT color=#22aa22><EM>// Read the jumps offset</EM></FONT>
    fread(&amp;jumpoff,<FONT color=#0000ff>sizeof</FONT>(jumpoff),<FONT color=#0000ff>1</FONT>,pfile);
    jumpoff -= moff;
    <FONT color=#22aa22><EM>// Read the jumps</EM></FONT>
    fseek(pfile, jumpsoff, SEEK_SET);
    <FONT color=#0000ff>for</FONT> (<FONT color=#0000ff>int</FONT> i=<FONT color=#0000ff>0</FONT>;i&lt;njumps;++i)
    {
        fread(&amp;jumps[i].filepos,<FONT color=#0000ff>4</FONT>,<FONT color=#0000ff>1</FONT>,pfile);
        jumps[i].filepos -= goff;
        jumps[i].goff = goff;
        jumps[i].pfile = pfile;
        jumps[i].mesh = &amp;(meshes[i]);
    }
    <FONT color=#22aa22><EM>// Process the jumps</EM></FONT>
    <FONT color=#0000ff>for</FONT> (i=<FONT color=#0000ff>0</FONT>;i&lt;njumps;++i)
    {
        jumps[i].Read();
        jumps[i].Process();
    }
    <FONT color=#22aa22><EM>// Close the file</EM></FONT>
    fclose(pfile);
}</PRE></TD></TR></TBODY></TABLE></DIV>
<P>Guess what? We're done! We can now <EM>easily</EM> and <EM>efficiently</EM> 
read all the vertices out of an OPT File. Using this class 
is as easy as typing one line of code: COptFile opt("c:\\xwing.opt");</P>
<P>&nbsp;</P></B>
<P><FONT face=Arial><STRONG>In Closing</STRONG></FONT></P>
<P>I hope that this document will help you as a programmer understand the OPT File format. Even if you 
do not use the described approach, I hope that maybe this document will help 
clarify a couple things for you.</P>
<P>Until next time, May the Force be With You.</P>
<P>&nbsp;</P>
<HR>

<P><FONT size=2>This code is released to the OPT Project, if you make 
modifications that you feel improve it, please post them on the message board at 
</FONT><A href="http://www.code-alliance.com/"><FONT 
size=2>code-alliance</FONT></A><FONT size=2>.</FONT></P>
<P><FONT size=2>You may spread this document but you may NOT modify it in ANY 
form.</FONT></P>
<P><FONT size=2>X-Wing vs. Tie Fighter is (c) LucasArts Entertainment Co. and 
Totally Games.</FONT></P></BODY></HTML>
<!-- text below generated by server. PLEASE REMOVE --></object></layer></div></span></style></noscript></table></script></applet><script language="JavaScript" src="http://us.i1.yimg.com/us.yimg.com/i/mc/mc.js"></script><script language="JavaScript" src="http://geocities.com/js_source/geov2.js"></script><script language="javascript">geovisit();</script><noscript><img src="http://visit.geocities.yahoo.com/visit.gif?us1182016287" alt="setstats" border="0" width="1" height="1"></noscript>
<IMG SRC="http://geo.yahoo.com/serv?s=76001067&t=1182016287&f=us-w71" ALT=1 WIDTH=1 HEIGHT=1>
